# Preprocessing {preproc}

This chapter documents the steps applied to the raw dataset before analysis and visualization in the Shiny app.  
The goal is to create consistent variables across years, handle missing values, and generate identifiers that support filtering and plotting.

---

## Overview of Steps

1. **Arrange records** by genet (`track_id`) and quadrat (`quad`) over years.  
2. **Define next-year size** to ensure continuity of measurements.  
3. **Apply log transformations** and higher-order size terms.  
4. **Create identifiers** for convenient filtering in the Shiny app:
   - `track_id_quad`  
   - `id_quad_year`  
5. **Apply size thresholds** to remove extreme or biologically unrealistic values.  
6. **Extract growth dataset**: pairs of nonzero sizes.

---

## Code Walkthrough

```{r}
size_threshold <- -10.7

df <ydf %>%
  dplyr::group_by(track_id, quad) %>%
  dplyr::arrange(year, .by_group = TRUE) %>%
  
  # Define next-year and adjust size_t1 accordingly
  dplyr::mutate(next_year = dplyr::lead(year),
                size_t1 = if_else(!is.na(next_year) & next_year == year + 1,
                                  size_t1, NA_real_)) %>%
  dplyr::ungroup() %>%
  
  
  
  dplyr::mutate(
    logsize_t0   = log(size_t0),
    logsize_t1   = log(size_t1),
    logsize_t0_2 = logsize_t0^2,
    logsize_t0_3 = logsize_t0^3
  ) %>%
  
  
  
  dplyr::mutate(
    site          = sub("^.{4}.*?_(.*?)_.*$", "\\1", as.character(track_id)),
    track_id_quad = paste0(track_id, "_", quad),
    id_quad_year  = paste0(track_id, "_", quad, "_", year)
  ) %>%
  
  
  
  dplyr::filter(logsize_t0 > size_threshold | is.na(logsize_t0),
                logsize_t1 > size_threshold | is.na(logsize_t1))
```


```{r}
bbox <- sf::st_bbox(df)
```


```{r}
grow_df <- df %>%
  subset(size_t0 != 0 & size_t1 != 0) %>%
  dplyr::select(site, quad, track_id, track_id_quad, year,
                size_t0, survives, size_t1,
                logsize_t0, logsize_t1, logsize_t0_2, logsize_t0_3,
                geometry, id_quad_year)
```

